<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shiva AI</title>
<!-- Font: Inter -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<!-- Icons: Phosphor Icons -->
<script src="https://unpkg.com/@phosphor-icons/web"></script>
<script>
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']]
    },
    svg: { fontCache: 'global' }
  };
</script>

<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

<style>
/* ===============================
   VARIABLES & RESET
================================ */
:root {
  --bg-dark: #0b0f19;
  --bg-sidebar: rgba(11, 15, 25, 0.95);
  --bg-surface: #131b2c;
  --accent: #2563eb;
  --accent-glow: rgba(37, 99, 235, 0.4);
  --text-main: #f3f4f6;
  --text-muted: #9ca3af;
  --border: rgba(255, 255, 255, 0.08);
  --radius-lg: 16px;
  --radius-md: 12px;
  --shadow-card: 0 4px 20px rgba(0, 0, 0, 0.4);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Inter', sans-serif;
  background-color: var(--bg-dark);
  color: var(--text-main);
  height: 100vh;
  overflow: hidden;
  position: relative;
}

/* Background Ambient Glows */
body::before, body::after {
  content: '';
  position: absolute;
  width: 500px;
  height: 500px;
  border-radius: 50%;
  filter: blur(100px);
  opacity: 0.15;
  z-index: -1;
  pointer-events: none;
}
body::before { background: var(--accent); top: -100px; left: -100px; }
body::after { background: #8b5cf6; bottom: -100px; right: -100px; }

/* ===============================
   LAYOUT
================================ */
.app-container {
  display: flex;
  height: 100vh;
  width: 100vw;
}

/* ===============================
   SIDEBAR
================================ */
.sidebar {
  width: 280px;
  background: var(--bg-sidebar);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  padding: 20px;
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  z-index: 100;
  backdrop-filter: blur(10px);
}

/* Profile Section */
.profile {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: rgba(255, 255, 255, 0.03);
  border-radius: var(--radius-md);
  border: 1px solid var(--border);
  margin-bottom: 20px;
  transition: 0.2s;
  cursor: pointer;
}
.profile:hover { background: rgba(255, 255, 255, 0.06); }
.avatar {
  width: 36px;
  height: 36px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
}
.profile-info h3 { font-size: 14px; font-weight: 500; }
.profile-info span { font-size: 11px; color: var(--text-muted); }

/* New Chat Button */
.new-chat-btn {
  width: 100%;
  padding: 12px;
  background: transparent;
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  color: var(--text-main);
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 14px;
}
.new-chat-btn:hover {
  background: var(--accent);
  border-color: var(--accent);
  box-shadow: 0 0 15px var(--accent-glow);
}

/* Chat List */
.chat-list {
  margin-top: 20px;
  flex: 1;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.chat-list-label {
  font-size: 11px;
  text-transform: uppercase;
  color: var(--text-muted);
  letter-spacing: 0.5px;
  margin-bottom: 8px;
}

.chat-item {
  padding: 10px 12px;
  border-radius: var(--radius-md);
  font-size: 13px;
  color: var(--text-muted);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: space-between;
  transition: 0.2s;
  position: relative;
  overflow: hidden;
  white-space: nowrap;
}
.chat-item span { text-overflow: ellipsis; overflow: hidden; width: 85%; }
.chat-item:hover { background: rgba(255, 255, 255, 0.04); color: var(--text-main); }
.chat-item.active { background: rgba(37, 99, 235, 0.15); color: var(--accent); border: 1px solid rgba(37, 99, 235, 0.2); }

/* Chat item actions (edit / delete) */
.chat-actions {
  display: flex;
  gap: 6px;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.chat-item:hover .chat-actions {
  opacity: 1;
}

.chat-actions i {
  font-size: 14px;
  padding: 4px;
  border-radius: 6px;
  cursor: pointer;
  color: var(--text-muted);
}

.chat-actions i:hover {
  background: rgba(255,255,255,0.1);
  color: white;
}

/* Custom Scrollbar */
.chat-list::-webkit-scrollbar { width: 4px; }
.chat-list::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }

/* ===============================
   MAIN CHAT AREA
================================ */
.main-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  position: relative;
  background: radial-gradient(circle at 50% 0%, #161f32 0%, var(--bg-dark) 60%);
}

/* Mobile Header */
.mobile-header {
  display: none;
  padding: 15px;
  border-bottom: 1px solid var(--border);
  align-items: center;
  justify-content: space-between;
  background: rgba(11, 15, 25, 0.8);
  backdrop-filter: blur(10px);
}

/* Chat History (Messages) */
.chat-history {
  flex: 1;
  overflow-y: auto;
  padding: 20px 0;
  display: flex;
  flex-direction: column;
  gap: 24px;
  scroll-behavior: smooth;
}

/* Empty State / Greeting */
.greeting-container {
  position: absolute;
  top: 40%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
  width: 100%;
  max-width: 600px;
  transition: opacity 0.3s;
}
.greeting-icon {
  width: 60px;
  height: 60px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 50%;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 15px;
  box-shadow: 0 0 30px rgba(0,0,0,0.2);
}
.greeting-container h1 { font-size: 24px; margin-bottom: 8px; font-weight: 600; }
.greeting-container p { color: var(--text-muted); font-size: 14px; }

/* Messages */
.message-wrapper {
  width: 100%;
  display: flex;
  justify-content: center;
  padding: 0 20px;
  opacity: 0;
  animation: slideUp 0.3s ease forwards;
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.message {
  display: flex;
  gap: 16px;
  max-width: 800px;
  width: 100%;
}

.message.user { justify-content: flex-end; }
.message.user .message-content {
  background: var(--accent);
  color: white;
  border-radius: 18px 18px 4px 18px;
  box-shadow: 0 4px 15px var(--accent-glow);
}
.message.bot .message-content {
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: 18px 18px 18px 4px;
  box-shadow: var(--shadow-card);
}

.message-avatar {
  width: 32px;
  height: 32px;
  border-radius: 8px;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
}
.message.bot .message-avatar { background: rgba(255, 255, 255, 0.05); color: white; }
.message.user .message-avatar { order: 2; background: #6366f1; color: white; }

.message-content {
  padding: 12px 16px;
  font-size: 15px;
  line-height: 1.5;
  position: relative;
  transition: transform 0.2s;
}
.message-content:hover { transform: scale(1.01); }

/* Typing Indicator */
.typing-indicator {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 12px 16px;
}
.dot {
  width: 6px;
  height: 6px;
  background: var(--text-muted);
  border-radius: 50%;
  animation: bounce 1.4s infinite ease-in-out both;
}
.dot:nth-child(1) { animation-delay: -0.32s; }
.dot:nth-child(2) { animation-delay: -0.16s; }

@keyframes bounce {
  0%, 80%, 100% { transform: scale(0); }
  40% { transform: scale(1); }
}
/* User message actions inside message box */
.message.user {
  position: relative;
}

.message.user .message-actions {
  position: absolute;
  top: 8px;
  right: 8px;
  display: flex;
  gap: 6px;
  opacity: 0;
  transition: opacity 0.2s ease;
  pointer-events: none; /* prevent accidental clicks when hidden */
}

.message.user:hover .message-actions {
  opacity: 1;
  pointer-events: auto;
}

.message-actions i {
  cursor: pointer;
  font-size: 14px;
  color: #fff;
  padding: 4px;
  border-radius: 6px;
  transition: background 0.2s;
}

.message-actions i:hover {
  background: rgba(255, 255, 255, 0.15);
}

/* ===============================
   INPUT AREA
================================ */
.input-area-wrapper {
  padding: 24px;
  display: flex;
  justify-content: center;
  background: linear-gradient(to top, var(--bg-dark) 40%, transparent);
}

.input-container {
  width: 100%;
  max-width: 800px;
  position: relative;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid var(--border);
  border-radius: 30px;
  padding: 8px 8px 8px 20px;
  display: flex;
  align-items: center;
  backdrop-filter: blur(10px);
  box-shadow: 0 4px 30px rgba(0,0,0,0.2);
  transition: all 0.3s ease;
}

.input-container:focus-within {
  border-color: var(--accent);
  box-shadow: 0 0 20px var(--accent-glow);
  background: rgba(11, 15, 25, 0.8);
}

.chat-input {
  flex: 1;
  background: transparent;
  border: none;
  color: var(--text-main);
  font-size: 15px;
  outline: none;
  height: 40px;
}

.send-btn {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: var(--accent);
  border: none;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: transform 0.2s, background 0.2s;
  font-size: 18px;
}

.send-btn:hover {
  background: #1d4ed8;
  transform: scale(1.1);
}
.send-btn:disabled {
  background: #333;
  cursor: not-allowed;
  transform: none;
}

/* ===============================
   RESPONSIVE
================================ */
@media (max-width: 768px) {
  .sidebar {
    position: fixed;
    left: -100%;
    height: 100%;
    box-shadow: 5px 0 30px rgba(0,0,0,0.5);
  }
  .sidebar.open { left: 0; }
  .mobile-header { display: flex; }
  .greeting-container { padding: 0 20px; }
}
.message-content {
  padding: 16px 20px;
}

.message-content b {
  color: #93c5fd;
}

.message-content br {
  line-height: 1.8;
}
.message-content ul,
.message-content ol {
  margin: 10px 0 10px 20px;
  padding-left: 18px;
}

.message-content li {
  margin-bottom: 8px;
  line-height: 1.6;
}

.message-content b {
  display: block;
  margin: 10px 0 6px;
  color: #93c5fd;
}
/* User message actions */
.message.user .message-actions {
  position: absolute;
  top: 8px;
  right: 8px;
  display: flex;
  gap: 6px;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.message.user:hover .message-actions {
  opacity: 1;
}

.message-actions i {
  cursor: pointer;
  font-size: 14px;
  color: #fff;
  padding: 4px;
  border-radius: 6px;
  transition: background 0.2s;
}

.message-actions i:hover {
  background: rgba(255, 255, 255, 0.15);
}
.message.user .message-actions {
  position: absolute;
  top: 8px;
  right: 8px;
  display: flex;
  gap: 6px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s ease;
}

.message.user:hover .message-actions {
  opacity: 1;
  pointer-events: auto;
}

.message-actions i {
  font-size: 14px;
  color: #fff;
  cursor: pointer;
  padding: 4px;
  border-radius: 6px;
  transition: background 0.2s;
}

.message-actions i:hover {
  background: rgba(255,255,255,0.15);
}

</style>
</head>
<body>

<div class="app-container">
  
  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="profile">
      <div class="avatar">S</div>
      <div class="profile-info">
        <h3>Shiva AI</h3>
        <span>By Bhavesh</span>
      </div>
    </div>

    <button class="new-chat-btn" onclick="startNewChat()">
      <i class="ph ph-plus"></i> New Chat
    </button>

    <div class="chat-list" id="chatList">
      <div class="chat-list-label">Recent Chats</div>
      <div class="chat-item active" onclick="loadChat(this)">
        <i class="ph ph-chat-circle"></i>
        <span>UI Design Principles</span>
      </div>
      <div class="chat-item" onclick="loadChat(this)">
        <i class="ph ph-chat-circle"></i>
        <span>React Project Ideas</span>
      </div>
      <div class="chat-item" onclick="loadChat(this)">
        <i class="ph ph-chat-circle"></i>
        <span>Math Homework</span>
      </div>
    </div>
  </aside>

  <!-- MAIN AREA -->
  <main class="main-content">
    
    <!-- Mobile Header -->
    <div class="mobile-header">
      <i class="ph ph-list" style="font-size: 24px; cursor: pointer;" onclick="toggleSidebar()"></i>
      <span style="font-weight: 600;">Shiva AI</span>
      <i class="ph ph-plus" style="font-size: 24px; cursor: pointer;" onclick="startNewChat()"></i>
    </div>

    <!-- Greeting -->
<div class="greeting-container" id="greeting">
  <div class="greeting-icon">
    <img src="https://bookstore-nt.vercel.app/shiva.png" style="width:40px; height:40px; border-radius:50%;">
  </div>
  <h1>Welcome User</h1>
  <p>I can help you for getting Higher Marks in Class X Boards</p>
</div>

    <!-- Messages -->
    <div class="chat-history" id="chatHistory">
      <!-- Messages injected here via JS -->
    </div>

    <!-- Input -->
    <div class="input-area-wrapper">
      <div class="input-container">
        <input type="text" class="chat-input" id="messageInput" placeholder="Message Shiva AI..." onkeydown="if(event.key==='Enter') sendMessage()"
>
        <button class="send-btn" id="sendBtn" onclick="sendMessage()">
          <i class="ph ph-paper-plane-right-fill"></i>
        </button>
      </div>
    </div>

  </main>
</div>

<!-- HTML & CSS remain mostly the same, only JS updated -->
<script>
  const chatHistory = document.getElementById('chatHistory');
  const messageInput = document.getElementById('messageInput');
  const greeting = document.getElementById('greeting');
  const sidebar = document.getElementById('sidebar');
  const chatList = document.getElementById('chatList');

  let chats = JSON.parse(localStorage.getItem('shiva_chats')) || [];
  let currentChatId = null;

  // Initialize
  function initChats() {
    if (chats.length === 0) {
      startNewChat(true);
    } else {
      loadChatById(chats[0].id);
    }
    renderChatList();
  }

  function saveChats() {
    localStorage.setItem('shiva_chats', JSON.stringify(chats));
  }

  function renderChatList() {
  chatList.innerHTML = `<div class="chat-list-label">Recent Chats</div>`;

  chats.forEach(chat => {
    const div = document.createElement('div');
    div.className = 'chat-item' + (chat.id === currentChatId ? ' active' : '');
    div.dataset.id = chat.id;

    div.innerHTML = `
      <span>${chat.title}</span>
      <div class="chat-actions">
        <i class="ph ph-pencil-simple"
           onclick="editChatTitle(event, ${chat.id})"></i>
        <i class="ph ph-trash"
           onclick="deleteChat(event, ${chat.id})"></i>
      </div>
    `;

    div.onclick = () => loadChatById(chat.id);
    chatList.appendChild(div);
  });
}


  function startNewChat(skipRender=false) {
    const chat = { id: Date.now(), title: 'New Chat', messages: [] };
    chats.unshift(chat);
    currentChatId = chat.id;
    saveChats();
    if (!skipRender) renderChatList();
    chatHistory.innerHTML = '';
    greeting.style.display = 'block';
    setTimeout(() => greeting.style.opacity = '1', 50);
  }

  function loadChatById(id) {
    currentChatId = id;
    const chat = chats.find(c => c.id === id);
    if (!chat) return;
    chatHistory.innerHTML = '';
    if(chat.messages.length === 0){
      greeting.style.display = 'block';
      setTimeout(()=>greeting.style.opacity='1',50);
    } else greeting.style.display='none';
    chat.messages.forEach(m=>addMessage(m.text,m.sender,false));
    renderChatList();
    scrollToBottom();
  }

async function sendMessage() {
    const text = messageInput.value.trim();
    if (!text || currentChatId === null) return;

    messageInput.value = '';
    greeting.style.opacity = '0';
    setTimeout(() => greeting.style.display='none', 300);

    addMessage(text, 'user');
    window.lastUserQuestion = text;

    saveMessage('user', text);

    const typingId = showTypingIndicator();

    try {
        // ðŸ”¹ Call Flask backend
        const response = await fetch('/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: text })
        });

        const data = await response.json();
        removeTypingIndicator(typingId);

        if (data.reply) {
            addMessage(data.reply, 'bot', true, text);
            saveMessage('bot', data.reply);
        }
    } catch (err) {
        removeTypingIndicator(typingId);
        addMessage("âš ï¸ Shiva is facing a small issue. Please try again.", 'bot');
        saveMessage('bot', "âš ï¸ Shiva is facing a small issue. Please try again.");
    }
}

  function saveMessage(sender,text){
    const chat = chats.find(c=>c.id===currentChatId);
    if(!chat) return;
    chat.messages.push({ sender,text });
    if(chat.title==='New Chat' && sender==='user'){
      chat.title = text.slice(0,30);
    }
    saveChats();
    renderChatList();
  }
  function isExamQuestion(question = '') {
  const q = question.toLowerCase();

  return (
    q.includes("class") ||
    q.includes("define") ||
    q.includes("identify") ||
    q.includes("explain") ||
    q.includes("describe") ||
    q.includes("why") ||
    q.includes("what is") ||
    q.includes("give reason") ||
    q.includes("reaction") ||
    q.includes("equation") ||
    q.includes("chemistry") ||
    q.includes("physics") ||
    q.includes("biology") ||
    q.includes("history") ||
    q.includes("geography") ||
    q.includes("civics") ||
    q.includes("economics") ||
    q.includes("marks")
  );
}
function addMessage(text, sender, scroll = true) {
  const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

  const wrapper = document.createElement('div');
  wrapper.className = 'message-wrapper';

  const avatar =
    sender === 'user'
      ? `<i class="ph ph-user"></i>`
      : `<img src="https://bookstore-nt.vercel.app/shiva.png"
             style="width:32px;height:32px;border-radius:6px;">`;

  let actionsHTML = '';
  if(sender === 'user'){
    actionsHTML = `
      <div class="message-actions">
        <i class="ph ph-pencil-simple" onclick="editUserMessage(event)"></i>
        <i class="ph ph-copy" onclick="copyUserMessage(event)"></i>
      </div>
    `;
  } else if(sender === 'bot'){
    actionsHTML = `
      <div class="message-actions" style="top:auto; bottom:4px; right:4px;">
        <i class="ph ph-copy" onclick="copyBotMessage(event)"></i>
      </div>
    `;
  }

  wrapper.innerHTML = `
    <div class="message ${sender}">
      <div class="message-avatar">${avatar}</div>
      <div class="message-content">${text}${actionsHTML}</div>
    </div>
  `;

  chatHistory.appendChild(wrapper);

  if (window.MathJax) MathJax.typesetPromise([wrapper]);
  if (scroll) scrollToBottom();
}
let editingMessageId = null; // track currently editing message

function editUserMessage(e) {
  e.stopPropagation();
  const wrapper = e.target.closest('.message-wrapper');
  const contentDiv = wrapper.querySelector('.message-content');
  const currentText = contentDiv.childNodes[0].textContent;


  // Set editing state
  editingMessageId = wrapper.dataset.id || Date.now();
  wrapper.dataset.id = editingMessageId;

  // Hide all other messages and typing indicators
  document.querySelectorAll('.message-wrapper').forEach(msg => {
    if(msg !== wrapper) msg.style.display = 'none';
  });

  document.querySelectorAll('.typing-indicator').forEach(t => t.parentElement.style.display = 'none');

  // Populate input box
  messageInput.value = currentText;
  messageInput.focus();

  // Remove existing message content text (optional)
  contentDiv.style.opacity = '0.6';
}
function copyBotMessage(e) {
  e.stopPropagation();
  const contentDiv = e.target.closest('.message-content');
  // Remove the actions HTML before copying
  const cloned = contentDiv.cloneNode(true);
  const actions = cloned.querySelector('.message-actions');
  if(actions) actions.remove();
  const text = cloned.textContent.trim();
  navigator.clipboard.writeText(text);
}
// Save edit on send
async function sendMessage() {
  const text = messageInput.value.trim();
  if (!text || currentChatId === null) return;

  if(editingMessageId){
    // Editing mode: update message
    const wrapper = document.querySelector(`.message-wrapper[data-id="${editingMessageId}"]`);
    if(wrapper){
      const contentDiv = wrapper.querySelector('.message-content');
      contentDiv.childNodes[0].textContent = text;
      contentDiv.style.opacity = '1';
      wrapper.style.display = 'flex';
    }

    // Show all hidden messages
    document.querySelectorAll('.message-wrapper').forEach(msg => msg.style.display = 'flex');
    editingMessageId = null;
  } else {
    // Normal send
    addMessage(text, 'user');
    saveMessage('user', text);
  }

  messageInput.value = '';
  greeting.style.opacity = '0';
  setTimeout(() => greeting.style.display='none', 300);

  const typingId = showTypingIndicator();

  try {
      const response = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text })
      });

      const data = await response.json();
      removeTypingIndicator(typingId);

      if (data.reply) {
          addMessage(data.reply, 'bot', true, text);
          saveMessage('bot', data.reply);
      }
  } catch (err) {
      removeTypingIndicator(typingId);
      addMessage("âš ï¸ Shiva is facing a small issue. Please try again.", 'bot');
      saveMessage('bot', "âš ï¸ Shiva is facing a small issue. Please try again.");
  }
}

// Copy user message
function copyUserMessage(e) {
  e.stopPropagation();
  const contentDiv = e.target.closest('.message-content');
  const text = contentDiv.childNodes[0].textContent;
  navigator.clipboard.writeText(text);
}

function formatExamStyle(raw) {

  raw = raw
    .replace(/[*_#`]/g, '')
    .replace(/\s+/g, ' ')
    .trim();

  const lower = raw.toLowerCase();

  let answer = '';
  let explanation = [];
  let equation = '';

  /* âœ… STEP 1: FORCE-CORRECT ANSWER (Chemistry Logic) */
  if (
    lower.includes('aluminium') ||
    lower.includes('aluminum') ||
    lower.includes(' al ')
  ) {
    answer = 'Aluminium (Al)';
  }

  /* fallback (generic short line) */
  if (!answer) {
    const lines = raw.split(/[.\n]/).map(l => l.trim()).filter(Boolean);
    for (let l of lines) {
      if (l.length <= 35) {
        answer = l;
        break;
      }
    }
  }

  if (!answer) answer = 'â€”';

  /* âœ… STEP 2: EXPLANATION (max 3 exam lines) */
  raw.split(/[.\n]/).forEach(l => {
    l = l.trim();
    if (
      l &&
      !l.toLowerCase().includes('answer') &&
      !l.includes('â†’') &&
      !l.includes('=') &&
      explanation.length < 3
    ) {
      explanation.push(l + '.');
    }
  });

  /* âœ… STEP 3: EQUATION DETECTION */
  const eqMatch = raw.match(/([A-Za-z0-9+ ]+(â†’|=)[A-Za-z0-9+ ]+)/);
  if (eqMatch) equation = eqMatch[1];

  return `
<b>Answer (Exam-Style):</b><br><br>

<b>The correct answer is:</b> ${answer}<br><br>

<b>Explanation:</b><br>
${explanation.join('<br>')}<br><br>

${equation
  ? `<b>If applicable, write the chemical equation / formula:</b><br>${equation}`
  : ''}
`;
}
function isSSTQuestion(question = '') {
  const q = question.toLowerCase();
  return (
    q.includes("sst") ||
    q.includes("history") ||
    q.includes("geography") ||
    q.includes("civics") ||
    q.includes("economics") ||
    q.includes("explain") ||
    q.includes("describe") ||
    q.includes("hazards") ||
    q.includes("mining")
  );
}
function formatChatStyle(raw) {
  return raw
    .replace(/\n{3,}/g, '\n\n')
    .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
    .replace(/\n/g, '<br>');
}

function forceBulletFormat(text) {

  // Convert markdown headings & bold
  text = text
    .replace(/###\s*(.*)/g, '<b>$1</b>')
    .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');

  // Split into lines
  let lines = text
    .split(/\n+/)
    .map(l => l.trim())
    .filter(Boolean);

  let listItems = [];

  lines.forEach(line => {
    // Skip equations
    if (line.includes("â†’") || line.includes("=")) {
      listItems.push(`<li>${line}</li>`);
    }
    // Skip headings already bold
    else if (line.startsWith("<b>")) {
      listItems.push(`</ul>${line}<ul>`);
    }
    else {
      listItems.push(`<li>${line}</li>`);
    }
  });

  return `
    <b>Answer (Exam-Oriented Points):</b>
    <ul>
      ${listItems.join("")}
    </ul>
  `;
}

  function showTypingIndicator(){
    const id = 'typing-'+Date.now();
    const wrapper = document.createElement('div');
    wrapper.className = 'message-wrapper';
    wrapper.id = id;
    wrapper.innerHTML = `
  <div class="message bot">
    <div class="message-avatar">
      <img src="https://bookstore-nt.vercel.app/shiva.png" style="width:32px;height:32px;border-radius:6px;">
    </div>
    <div class="message-content typing-indicator">
      <div class="dot"></div><div class="dot"></div><div class="dot"></div>
    </div>
  </div>
`;
    chatHistory.appendChild(wrapper);
    scrollToBottom();
    return id;
  }

  function removeTypingIndicator(id){
    const el = document.getElementById(id);
    if(el) el.remove();
  }

  function scrollToBottom(){
    chatHistory.scrollTop = chatHistory.scrollHeight;
  }

  // Init on load
  initChats();

  // Mobile toggle
  function toggleSidebar(){ sidebar.classList.toggle('open'); }
function deleteChat(e, id) {
  e.stopPropagation();

  if (!confirm("Delete this chat?")) return;

  chats = chats.filter(c => c.id !== id);

  if (currentChatId === id) {
    currentChatId = chats.length ? chats[0].id : null;
    chatHistory.innerHTML = '';
    greeting.style.display = 'block';
  }

  saveChats();
  renderChatList();
}

function editChatTitle(e, id) {
  e.stopPropagation();

  const chat = chats.find(c => c.id === id);
  if (!chat) return;

  const newTitle = prompt("Edit chat title:", chat.title);
  if (!newTitle) return;

  chat.title = newTitle.trim().slice(0, 40);
  saveChats();
  renderChatList();
}

  // Enter key
  messageInput.addEventListener('keydown', e=>{ if(e.key==='Enter') sendMessage(); });
</script>

</body>
</html>
