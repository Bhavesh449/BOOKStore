<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduPie | Master Your Knowledge</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --bg-dark: #0b1220;
            --card-bg: #111a2e;
            --neon-blue: #00f0ff;
            --neon-pink: #ff00f0;
            --text-main: #ffffff;
            --text-mute: #a0aec0;
            --glass: rgba(255, 255, 255, 0.05);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- Navigation --- */
      /* --- Navigation --- */
nav {
    display: grid; /* Change from flex to grid */
    grid-template-columns: 1fr auto 1fr; /* Left (1fr), Center (auto, the logo), Right (1fr) */
    align-items: center;
    padding: 1rem 2rem;
    background: rgba(11, 18, 32, 0.9);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid rgba(255,255,255,0.1);
    position: sticky;
    top: 0;
    z-index: 100;
}

/* The logo wrapper is the middle item, centered by the grid */
.logo-wrapper {
    justify-self: center; /* Center the wrapper content horizontally in its grid cell */
}

/* The authentication section is the third item, pushed to the right */
#auth-section {
    justify-self: end; /* Push auth section to the right of its grid cell */
}

/* Add a style for the placeholder to occupy the left grid cell */
.logo-placeholder {
    /* Ensures the left column exists for symmetry */
    min-width: 50px; /* Give it a minimum width if needed for alignment */
    justify-self: start;
}

.logo-img {
    height: 70px; /* Adjust size as needed */
    object-fit: contain;
}
        /* --- Buttons --- */
        button { cursor: pointer; border: none; transition: 0.3s; font-weight: bold; }

        .btn-neon {
            background: linear-gradient(90deg, var(--neon-blue), var(--neon-pink));
            color: #fff;
            padding: 10px 25px;
            border-radius: 30px;
            box-shadow: 0 0 15px rgba(0, 240, 255, 0.4);
        }
        .btn-neon:hover { transform: translateY(-2px); box-shadow: 0 0 25px rgba(255, 0, 240, 0.6); }

        .btn-small { background: transparent; border: 1px solid var(--neon-pink); color: var(--neon-pink); padding: 5px 15px; border-radius: 20px; margin-left: 10px; }
        .btn-small:hover { background: var(--neon-pink); color: white; }

        .btn-primary { background: var(--neon-blue); color: #000; padding: 10px 30px; border-radius: 8px; }
        .btn-primary:disabled { background: #333; color: #666; cursor: not-allowed; }

        .btn-secondary { background: transparent; border: 1px solid var(--text-mute); color: var(--text-mute); padding: 10px 30px; border-radius: 8px; }

        /* --- Views --- */
        .container { padding: 2rem 5%; max-width: 1200px; margin: 0 auto; }
        .view { display: none; animation: fadeIn 0.5s ease; }
        .view.active { display: block; }
        .hidden { display: none !important; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Dashboard --- */
        .section-title { margin-bottom: 2rem; border-left: 5px solid var(--neon-pink); padding-left: 15px; }

        .quiz-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
        }

        .quiz-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 2rem;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.05);
            transition: 0.4s;
        }

        .quiz-card:hover { transform: translateY(-10px); border-color: var(--neon-blue); box-shadow: 0 20px 40px rgba(0, 240, 255, 0.1); }
        .card-title { font-size: 1.5rem; margin-bottom: 0.5rem; color: var(--neon-blue); }
        .card-info { color: var(--text-mute); margin-bottom: 1.5rem; font-size: 0.9rem; }

        /* --- Quiz Interface --- */
        .quiz-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .timer-badge {
            background: rgba(255, 0, 240, 0.1);
            border: 1px solid var(--neon-pink);
            color: var(--neon-pink);
            padding: 8px 15px;
            border-radius: 20px;
            box-shadow: 0 0 10px rgba(255, 0, 240, 0.2);
            font-family: monospace;
            font-size: 1.2rem;
        }

        .progress-bar { height: 6px; background: #333; border-radius: 3px; margin-bottom: 2rem; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--neon-blue); width: 0%; transition: 0.3s; }

        .question-box { background: var(--card-bg); padding: 2rem; border-radius: 15px; margin-bottom: 2rem; border: 1px solid var(--neon-blue); box-shadow: 0 0 20px rgba(0, 240, 255, 0.1); }
        .question-box h3 { margin-bottom: 1.5rem; font-size: 1.3rem; }

        .options-grid { display: grid; gap: 1rem; }
        .option-btn {
            background: var(--glass);
            color: var(--text-mute);
            padding: 15px;
            border-radius: 8px;
            text-align: left;
            border: 1px solid transparent;
            transition: 0.2s;
        }
        .option-btn:hover { background: rgba(255,255,255,0.1); }
        .option-btn.selected {
            background: rgba(0, 240, 255, 0.1);
            border-color: var(--neon-blue);
            color: #fff;
            box-shadow: 0 0 10px rgba(0, 240, 255, 0.2);
        }

        .quiz-controls { display: flex; justify-content: space-between; align-items: center; }

        /* --- Report Card --- */
        .report-card {
            background: var(--card-bg);
            padding: 3rem;
            border-radius: 20px;
            text-align: center;
            max-width: 600px;
            margin: 0 auto;
            border-top: 4px solid var(--neon-pink);
        }

        #res-rank-title { /* Rank Title Style */
            font-size: 1.8rem; 
            margin-bottom: 1rem; 
            color: var(--neon-pink); 
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255, 0, 240, 0.5);
        }

        .score-circle {
            width: 150px; height: 150px;
            border-radius: 50%;
            border: 5px solid var(--neon-blue);
            display: flex; justify-content: center; align-items: center;
            font-size: 2.5rem; font-weight: bold;
            margin: 2rem auto;
            box-shadow: 0 0 20px rgba(0, 240, 255, 0.2);
        }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem; }
        .stat-box { padding: 1rem; border-radius: 10px; background: rgba(255,255,255,0.03); }
        .stat-box h3 { font-size: 0.9rem; color: var(--text-mute); margin-bottom: 5px; }
        .stat-box span { font-size: 1.5rem; font-weight: bold; }

        .correct span { color: #00ff88; }
        .wrong span { color: #ff4444; }
        .attempted span { color: var(--neon-blue); }

        .time-stat { margin-bottom: 2rem; color: var(--text-mute); }

        /* --- Toast --- */
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: var(--neon-pink);
            color: #fff;
            text-align: center;
            border-radius: 5px;
            padding: 16px;
            position: fixed;
            z-index: 1;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }

        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        
        /* --- Leaderboard Styles --- */
        .leaderboard-container {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.05);
            max-width: 900px;
            margin: 0 auto;
        }

        .table-responsive {
            overflow-x: auto;
            margin: 2rem 0;
        }

        .lb-table {
            width: 100%;
            border-collapse: collapse;
            color: var(--text-main);
        }

        .lb-table th {
            background: rgba(0, 240, 255, 0.1);
            color: var(--neon-blue);
            padding: 15px;
            text-align: left;
            font-size: 1.1rem;
            border-bottom: 2px solid var(--neon-blue);
        }

        .lb-table td {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: 0.3s;
        }

        .lb-table tr:hover td {
            background: rgba(255, 0, 240, 0.05);
            color: #fff;
        }

        /* Rank Styling */
        .rank-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        .rank-badge {
            display: inline-block;
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
            border-radius: 50%;
            font-weight: bold;
            background: #333;
        }

        /* Top 3 Highlighting */
        tr:nth-child(1) .rank-badge { background: #FFD700; color: #000; box-shadow: 0 0 10px #FFD700; } /* Gold */
        tr:nth-child(2) .rank-badge { background: #C0C0C0; color: #000; box-shadow: 0 0 10px #C0C0C0; } /* Silver */
        tr:nth-child(3) .rank-badge { background: #CD7F32; color: #000; box-shadow: 0 0 10px #CD7F32; } /* Bronze */

        .player-info {
            display: flex;
            flex-direction: column;
        }
        .player-name { font-weight: bold; font-size: 1rem; }
        .player-email { font-size: 0.8rem; color: var(--text-mute); }
        .player-rank-title { /* Style for rank title under player name */
            font-size: 0.8rem; 
            color: var(--neon-pink); 
            font-weight: bold;
            /* Added margin-top to separate rank title from name if email is not present */
            margin-top: 2px; 
        }
        /* If player-email is not present, we want player-rank-title to be directly under player-name */
        .player-info .player-rank-title {
             /* Resetting the default margin-top if email is present, ensuring spacing */
             margin-top: 5px; 
        }
        .score-text {
            font-weight: bold;
            color: var(--neon-pink);
            font-size: 1.1rem;
        }
        #mainContent {
    display: none;
}
.madeby {
  font-size: 18px;
  font-weight: bold;
  margin-bottom: 6px;
  background: linear-gradient(90deg, #6dd5fa, #2980b9, #6dd5fa);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  text-shadow: 0 0 10px rgba(0,153,255,0.6);
  animation: glowMove 3s infinite linear;
}

@keyframes glowMove {
  0% { text-shadow: 0 0 8px #1e90ff; }
  50% { text-shadow: 0 0 16px #00c3ff; }
  100% { text-shadow: 0 0 8px #1e90ff; }
}
    </style>
</head>
<body>

    <nav>
    <div class="logo-placeholder"></div> <div class="logo-wrapper"> <img src="edupie.png" alt="EduPie Logo" class="logo-img">
    </div>

    <div id="auth-section">
        <button id="login-btn" class="btn-neon">
            <i class="fab fa-google"></i> Login
        </button>
        <div id="user-info" class="hidden">
            <span id="user-name">User</span>
            <button id="logout-btn" class="btn-small">Logout</button>
        </div>
    </div>
</nav>

    <div class="container">
        
        <div id="dashboard-view" class="view active">
            <h1 class="section-title">Available Quizzes</h1>
            <div class="quiz-grid" id="quiz-container">
            </div>
        </div>

        <div id="quiz-view" class="view hidden">
            <div class="quiz-header">
                <h2 id="quiz-title-display">Subject Name</h2>
                <div class="timer-badge">
                    <i class="fas fa-clock"></i> <span id="timer">00:00</span>
                </div>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>

            <div class="question-box">
                <h3 id="question-text">Question goes here?</h3>
                <div class="options-grid" id="options-container">
                </div>
            </div>

            <div class="quiz-controls">
                <button id="prev-btn" class="btn-secondary" disabled>Previous</button>
                <p class="q-counter">Question <span id="q-current">1</span> / <span id="q-total">5</span></p>
                <button id="next-btn" class="btn-primary" disabled>Next</button>
            </div>
        </div>

        <div id="result-view" class="view hidden">
            <div class="report-card">
                
                <h2>Quiz Report Card</h2>
                <p id="res-rank-title">Rank Name</p>

                <div class="score-circle">
                    <span id="score-percentage">0%</span>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-box correct">
                        <h3>Correct</h3>
                        <span id="res-correct">0</span>
                    </div>
                    <div class="stat-box wrong">
                        <h3>Wrong</h3>
                        <span id="res-wrong">0</span>
                    </div>
                    <div class="stat-box attempted">
                        <h3>Attempted</h3>
                        <span id="res-attempted">0</span>
                    </div>
                    <div class="stat-box unattempted">
                        <h3>Skipped</h3>
                        <span id="res-unattempted">0</span>
                    </div>
                </div>

                <div class="time-stat">
                    Time Taken: <span id="res-time">0s</span>
                </div>
                <button id="view-lb-from-res" class="btn-secondary" style="margin-bottom: 1rem;">View Leaderboard</button>
                <button id="back-home-btn" class="btn-neon">Back to Dashboard</button>
            </div>
        </div>
        
        <div id="leaderboard-view" class="view hidden">
            <div class="leaderboard-container">
                <h2 class="section-title">üèÜ Top Performers: <span id="lb-quiz-title">General Quiz</span></h2>
                
                <div class="table-responsive">
                    <table class="lb-table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Player</th>
                                <th>Score</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody id="lb-body">
                        </tbody>
                    </table>
                </div>

                <div class="lb-controls">
                    <button id="lb-back-btn" class="btn-neon">Back to Dashboard</button>
                </div>
            </div>
        </div>

    </div>
<footer style="background:#0b1220;color:white;text-align:center;padding:20px 10px;font-size:14px;">
  <div class="madeby">Made by Bhavesh </div>
    <p>¬© 2025 BOOKStore. All rights reserved.</p>
  <p>
    <a href="privacy.html" style="color:#58a6ff;text-decoration:none;">Privacy Policy</a> |
    <a href="about.html" style="color:#58a6ff;text-decoration:none;">About Us</a>
  </p>
</footer>
    <div id="toast">Please login to enroll!</div>

    <script type="module">
// Import Firebase functions from CDN (v9 Modular SDK)
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
import { getDatabase, ref, get, child, update, onValue } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

// --------------------------------------------------------------
// !!! IMPORTANT: REPLACE WITH YOUR FIREBASE CONFIG !!!
// --------------------------------------------------------------
const firebaseConfig = {
    apiKey: "AIzaSyCcpG-oEqkDprgTwWXKt5CFsttjAQAZFNg",
    authDomain: "bookstore-6ab08.firebaseapp.com",
    databaseURL: "https://bookstore-6ab08-default-rtdb.firebaseio.com",
    projectId: "bookstore-6ab08",
    storageBucket: "bookstore-6ab08.firebasestorage.app",
    messagingSenderId: "102226032749",
    appId: "1:102226032749:web:f7090175d2e53c2f522764"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
const provider = new GoogleAuthProvider();

// --- DATA: QUIZZES ---
const quizzes = [
    {
        id: "science_01",
        title: "Science Quiz",
        subject: "Class 10th",
        questions: [
            { q: "You are given water, mustard oil, glycerine, and kerosene. In which of these media will a ray of light incident obliquely at the same angle bend the most? (CBSE 2023)", options: ["(a) Kerosene", "(b) Water", "(c) Mustard oil", "(d) Glycerine"], ans: 3 },
            { q: "The direction of the force on a current-carrying conductor in a magnetic field is given by: (CBSE 2024)", options: ["(a) Fleming‚Äôs Left-Hand Rule", "(b) Fleming‚Äôs Right-Hand Rule", "(c) Right-Hand Thumb Rule", "(d) Left-Hand Thumb Rule"], ans: 0 },
            { q: "A cylindrical conductor of length l and uniform area of cross-section A has resistance R. Another conductor of length 2l and resistance R of the same material has an area of cross-section:", options: ["(a) A/2", "(b) 3A/2", "(c) 2A", "(d) 3A"], ans: 2 },
            { q: "Electrolysis of water is a decomposition reaction. The mole ratio of hydrogen and oxygen gases liberated during electrolysis of water is: (CBSE 2023)", options: ["(a) 1:1", "(b) 2:1", "(c) 4:1", "(d) 1:2"], ans: 1 },
            { q: "Which of the following correct represents the reaction involved when electricity is passed through water? (CBSE 2024)", options: ["(a) Displacement", "(b) Combination", "(c) Decomposition", "(d) Double Displacement"], ans: 2 }
        ]
    },
    {
        id: "math_01",
        title: "Math Quiz",
        subject: "Class 10th",
        questions: [
            { q: "The HCF of two consecutive even numbers is always:", options: ["(a) 1", "(b) 2", "(c) 4", "(d) A Prime Number"], ans: 1 },
            { q: "The pair of linear equations 2x = 5y + 6 and 15y = 6x - 18 represents two lines which are: ", options: ["(a) intersecting", "(b) parallel", "(c) coincident", "(d) either intersecting or parallel"], ans: 2 },
            { q: "The distance of the point (4, 7) from the x-axis is:", options: ["(a) 7 units", "(b) 5 units", "(c) 4 units", "(d) 10 units"], ans: 0 },
            { q: "The next term of the A.P.: ‚àö7, ‚àö28, ‚àö63 is", options: ["(a) ‚àö70", "(b) ‚àö80", "(c) ‚àö97", "(d) ‚àö112"], ans: 3 },
            { q: "If a bicycle wheel makes 5000 revolutions in moving 11 km, then the diameter of the wheel is:", options: ["(a)65 cm", "(b)35 cm", "(c) 70 cm", "(d) 50 cm"], ans: 2 }
        ]
    },
    {
        id: "sst_01",
        title: "SST Quiz",
        subject: "Class 10th",
        questions: [
            { q: "The immediate cause for calling off the Non-Cooperation Movement by Gandhiji was:", options: ["(a) The signing of the Gandhi-Irwin Pact.", "(b) Increasing pressure from the British government.", "(c) The Chauri Chaura Incident.", "(d) Failure to achieve Swaraj within one year."], ans: 2 },
            { q: "The form of power sharing adopted by the Belgian model is best described as:", options: ["(a) Vertical division of power.", "(b) Holding together federation.", "(c) Coming together federation.", "(d) Coalition government at the national level."], ans: 1 },
            { q: "Which of the following is an example of an Intermediate Good?", options: ["(a) A bus bought by a school.", "(b) Flour purchased by a baker to make bread.", "(c) A tractor purchased by a farmer.", "(d) A new car bought by a family."], ans: 1 },
            { q: "Which resource is formed due to the decomposition of rocks, leaving a residual mass of weathered material?", options: ["(a) Mica", "(b) Iron Ore", "(c) Copper", "(d) Bauxite"], ans: 3 },
        ]
    }
    
];

// --- RANK TIERS ---
// Based on 5 questions max. 
const rankTiers = [
    { title: "Bronze", minScore: 0, maxScore: 1, icon: "ü•ö" },
    { title: "Gold", minScore: 2, maxScore: 3, icon: "ü•â" },
    { title: "Diamond", minScore: 4, maxScore: 4, icon: "ü•à" },
    { title: "GrandMaster", minScore: 5, maxScore: 5, icon: "ü•á" } 
];

function getRankTitle(score, totalQuestions) {
    // Adjust rank tiers based on the actual number of questions
    const tiers = rankTiers.map(tier => ({ 
        ...tier, 
        maxScore: Math.min(tier.maxScore, totalQuestions)
    }));
    const rank = tiers.find(t => score >= t.minScore && score <= t.maxScore);
    return rank ? `${rank.icon} ${rank.title}` : "Unknown Rank";
}

// --- UTILITY FUNCTIONS ---

/**
 * Encodes an email address into a Firebase Realtime Database safe key.
 * Replaces '.', '#', '$', '[', ']', and '@' with safe strings.
 * @param {string} email 
 * @returns {string} The safe key.
 */
function encodeEmailToKey(email) {
    if (!email) return 'anonymous_user';
    return email
        .replace(/\./g, '_dot_')
        .replace(/#/g, '_hash_')
        .replace(/\$/g, '_dollar_')
        .replace(/\[/g, '_openbracket_')
        .replace(/\]/g, '_closebracket_')
        .replace(/@/g, '_at_');
}

/**
 * Decodes a Firebase safe key back into a standard email address.
 * @param {string} key 
 * @returns {string} The decoded email.
 */
function decodeKeyToEmail(key) {
    if (!key) return 'N/A';
    return key
        .replace(/_dot_/g, '.')
        .replace(/_hash_/g, '#')
        .replace(/_dollar_/g, '$')
        .replace(/_openbracket_/g, '[')
        .replace(/_closebracket_/g, ']')
        .replace(/_at_/g, '@');
}

// --- STATE MANAGEMENT ---
let currentUser = null;
let currentQuiz = null;
let currentQuestionIndex = 0;
let userAnswers = {}; 
let timerInterval;
let startTime;
let endTime;

// --- DOM ELEMENTS ---
const views = {
    dashboard: document.getElementById('dashboard-view'),
    quiz: document.getElementById('quiz-view'),
    result: document.getElementById('result-view'),
    leaderboard: document.getElementById('leaderboard-view') 
};
const els = {
    authSection: document.getElementById('auth-section'),
    loginBtn: document.getElementById('login-btn'),
    userInfo: document.getElementById('user-info'),
    userName: document.getElementById('user-name'),
    logoutBtn: document.getElementById('logout-btn'),
    quizContainer: document.getElementById('quiz-container'),
    // Quiz Elements
    quizTitle: document.getElementById('quiz-title-display'),
    timer: document.getElementById('timer'),
    progressBar: document.getElementById('progress-fill'),
    questionText: document.getElementById('question-text'),
    optionsContainer: document.getElementById('options-container'),
    prevBtn: document.getElementById('prev-btn'),
    nextBtn: document.getElementById('next-btn'),
    qCurrent: document.getElementById('q-current'),
    qTotal: document.getElementById('q-total'),
    // Result Elements
    scorePercent: document.getElementById('score-percentage'),
    resRankTitle: document.getElementById('res-rank-title'), 
    resCorrect: document.getElementById('res-correct'),
    resWrong: document.getElementById('res-wrong'),
    resAttempted: document.getElementById('res-attempted'),
    resUnattempted: document.getElementById('res-unattempted'),
    resTime: document.getElementById('res-time'),
    backHomeBtn: document.getElementById('back-home-btn')
};

// --- AUTHENTICATION & NAVIGATION ---

els.loginBtn.addEventListener('click', () => {
    signInWithPopup(auth, provider).catch(err => console.error(err));
});

els.logoutBtn.addEventListener('click', () => {
    signOut(auth).then(() => {
        switchView('dashboard');
        showToast("Logged out successfully");
    });
});
auth.onAuthStateChanged((user) => {
    if (user) {
        // User is logged in ‚Üí show content or redirect to edupie dashboard
        console.log("Auto-logged in as:", user.email);
        // Example: show main content
        document.getElementById("mainContent").style.display = "block";
    } else {
        // Not logged in ‚Üí redirect to login page
        window.location.href = "index.html"; 
    }
});

onAuthStateChanged(auth, (user) => {
    currentUser = user;
    if (user) {
        els.loginBtn.classList.add('hidden');
        els.userInfo.classList.remove('hidden');
        // Fallback for user name just in case
        els.userName.textContent = user.displayName ? user.displayName.split(' ')[0] : 'Guest';
        loadDashboard();
    } else {
        els.loginBtn.classList.remove('hidden');
        els.userInfo.classList.add('hidden');
        loadDashboard(); 
    }
});

function switchView(viewName) {
    Object.values(views).forEach(v => v.classList.remove('active', 'hidden'));
    Object.values(views).forEach(v => v.classList.add('hidden'));
    views[viewName].classList.remove('hidden');
    views[viewName].classList.add('active');
}

function showToast(msg) {
    const toast = document.getElementById("toast");
    toast.textContent = msg;
    toast.className = "show";
    setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
}

// --- DASHBOARD ---
async function loadDashboard() {
    els.quizContainer.innerHTML = '<p style="color:white">Loading Quizzes...</p>';
    
    let userResults = {};
    if (currentUser && currentUser.email) {
        // Use sanitized email key for fetching personal results
        const personalKey = encodeEmailToKey(currentUser.email);
        const dbRef = ref(db);
        try {
            const snapshot = await get(child(dbRef, `results/${personalKey}`));
            if (snapshot.exists()) {
                userResults = snapshot.val();
            }
        } catch (error) {
            console.error("Error fetching data", error);
        }
    }

    els.quizContainer.innerHTML = '';
    
    quizzes.forEach(quiz => {
        // Check if the quiz was taken based on the results fetched using the email key
        const hasTaken = userResults[quiz.id] ? true : false;
        
        const card = document.createElement('div');
        card.className = 'quiz-card';
        card.innerHTML = `
            <h2 class="card-title">${quiz.title}</h2>
            <p class="card-info">${quiz.subject} ‚Ä¢ ${quiz.questions.length} Questions</p>
            <div class="card-actions">
                <button class="btn-neon action-btn" data-id="${quiz.id}" data-taken="${hasTaken}">
                    ${hasTaken ? 'View Result' : 'Enroll Now'}
                </button>
                <button class="btn-small lb-btn" data-id="${quiz.id}">
                    <i class="fas fa-trophy"></i> Leaderboard
                </button>
            </div>
        `;
        els.quizContainer.appendChild(card);
    });

    document.querySelectorAll('.action-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const quizId = e.target.closest('button').dataset.id;
            const taken = e.target.closest('button').dataset.taken === 'true';
            handleQuizAction(quizId, taken);
        });
    });

    document.querySelectorAll('.lb-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const quizId = e.target.closest('button').dataset.id;
            loadLeaderboard(quizId);
        });
    });
}

function handleQuizAction(quizId, taken) {
    if (!currentUser || !currentUser.email) {
        showToast("Please Login with a valid email to continue!");
        return;
    }
    const selectedQuiz = quizzes.find(q => q.id === quizId);
    if (taken) {
        fetchAndShowResult(quizId);
    } else {
        startQuiz(selectedQuiz);
    }
}

// --- QUIZ ENGINE ---
function startQuiz(quiz) {
    currentQuiz = quiz;
    currentQuestionIndex = 0;
    userAnswers = {};
    startTime = new Date();
    
    els.quizTitle.textContent = quiz.title;
    els.qTotal.textContent = quiz.questions.length;
    
    startTimer();
    switchView('quiz');
    renderQuestion();
}

function startTimer() {
    let seconds = 0;
    clearInterval(timerInterval);
    els.timer.textContent = "00:00";
    
    timerInterval = setInterval(() => {
        seconds++;
        const m = Math.floor(seconds / 60).toString().padStart(2, '0');
        const s = (seconds % 60).toString().padStart(2, '0');
        els.timer.textContent = `${m}:${s}`;
    }, 1000);
}

function renderQuestion() {
    const qData = currentQuiz.questions[currentQuestionIndex];
    els.questionText.textContent = `${currentQuestionIndex + 1}. ${qData.q}`;
    els.qCurrent.textContent = currentQuestionIndex + 1;
    
    const progress = ((currentQuestionIndex) / currentQuiz.questions.length) * 100;
    els.progressBar.style.width = `${progress}%`;

    els.optionsContainer.innerHTML = '';
    qData.options.forEach((opt, index) => {
        const btn = document.createElement('button');
        btn.className = 'option-btn';
        btn.textContent = opt;
        if (userAnswers[currentQuestionIndex] === index) {
            btn.classList.add('selected');
        }
        btn.addEventListener('click', () => selectOption(index));
        els.optionsContainer.appendChild(btn);
    });

    els.prevBtn.disabled = currentQuestionIndex === 0;
    els.nextBtn.textContent = (currentQuestionIndex === currentQuiz.questions.length - 1) ? "Submit" : "Next";
    // Next button is disabled until an answer is selected for the current question
    els.nextBtn.disabled = userAnswers[currentQuestionIndex] === undefined;
}

function selectOption(index) {
    userAnswers[currentQuestionIndex] = index;
    const buttons = els.optionsContainer.children;
    for (let btn of buttons) btn.classList.remove('selected');
    buttons[index].classList.add('selected');
    els.nextBtn.disabled = false;
}

els.prevBtn.addEventListener('click', () => {
    if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        renderQuestion();
    }
});

els.nextBtn.addEventListener('click', () => {
    if (currentQuestionIndex < currentQuiz.questions.length - 1) {
        currentQuestionIndex++;
        renderQuestion();
    } else {
        submitQuiz();
    }
});


// --- LEADERBOARD LOGIC ---

let currentLeaderboardQuizId = null;
let unsubscribeLeaderboard = null;

// Helper function to format seconds into MM:SS
function formatSeconds(seconds) {
    if (typeof seconds !== 'number' || isNaN(seconds) || seconds < 0) {
        return 'N/A';
    }
    const m = Math.floor(seconds / 60).toString().padStart(2, '0');
    const s = (seconds % 60).toString().padStart(2, '0');
    return `${m}:${s}`;
}


async function loadLeaderboard(quizId) {
    if (unsubscribeLeaderboard) {
        unsubscribeLeaderboard(); // Stop listening to previous quiz
    }

    currentLeaderboardQuizId = quizId;
    const quiz = quizzes.find(q => q.id === quizId);
    document.getElementById('lb-quiz-title').textContent = quiz ? quiz.title : 'Quiz';

    const lbBody = document.getElementById('lb-body');
    lbBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Loading scores...</td></tr>';
    
    switchView('leaderboard'); 

    const dbRef = ref(db, `leaderboardquiz/${quizId}`);
    
    // Use onValue for real-time updates
    unsubscribeLeaderboard = onValue(dbRef, (snapshot) => {
        if (snapshot.exists()) {
            const data = snapshot.val();
            
            // Convert the object keyed by encoded email/UID back into an array
            let entries = Object.entries(data).map(([key, entry]) => ({
                ...entry,
                // Add the decoded key back as the email field for display
                email: decodeKeyToEmail(key) 
            }));

            // Sorting Logic: 1. Higher Score 2. Lower Time
            entries.sort((a, b) => {
                if (b.score !== a.score) {
                    return b.score - a.score; 
                }
                // Ensure timeSeconds is a number for sorting, default to a high number if missing
                const timeA = a.timeSeconds || 999999;
                const timeB = b.timeSeconds || 999999;
                return timeA - timeB;
            });

            const top10 = entries.slice(0, 10);

            // Render
            lbBody.innerHTML = '';
            top10.forEach((entry, index) => {
                // Determine Total Questions 
                const totalQ = entry.totalQuestions || (quiz ? quiz.questions.length : 5);
                
                // Generate time display
                const timeDisplay = entry.timeString || formatSeconds(entry.timeSeconds);
                
                // Fallback for rank title
                const rankTitle = entry.rankTitle || 'N/A';
                
                // Set the player email for display
                const playerEmail = entry.email; 
                
                // Only display email if it's not 'N/A' or anonymous
                let emailSpan = '';
                if (playerEmail && playerEmail !== 'anonymous_user' && playerEmail !== 'N/A') { 
                    emailSpan = `<span class="player-email">${playerEmail}</span>`;
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <!-- Only Rank Badge in the Rank column -->
                        <span class="rank-badge">${index + 1}</span>
                    </td>
                    <td>
                        <!-- Player Name, (Optional) Email, and Rank Title here -->
                        <div class="player-info">
                            <span class="player-name">${entry.name || 'Anonymous'}</span>
                            ${emailSpan} <!-- Insert email span only if valid email is present -->
                            <span class="player-rank-title">${rankTitle}</span> 
                        </div>
                    </td>
                    <td><span class="score-text">${entry.score || 0}/${totalQ}</span></td>
                    <td>${timeDisplay}</td>
                `;
                lbBody.appendChild(row);
            });
        } else {
            lbBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No attempts yet. Be the first!</td></tr>';
        }
    }, (error) => {
        console.error("Firebase Read Error:", error);
        lbBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Error loading leaderboard.</td></tr>';
    });
}

document.getElementById('lb-back-btn').addEventListener('click', () => {
    if (unsubscribeLeaderboard) {
        unsubscribeLeaderboard(); // Stop real-time listener when leaving
        unsubscribeLeaderboard = null;
    }
    loadDashboard();
    switchView('dashboard');
});


// --- SUBMISSION & DATA STORAGE (UPDATED) ---
async function submitQuiz() {
    if (!currentUser || !currentUser.email) {
        showToast("Error: No valid email found for submission.");
        return;
    }
    
    clearInterval(timerInterval);
    endTime = new Date();
    const timeTakenSec = Math.floor((endTime - startTime) / 1000); 
    const timeDisplay = els.timer.textContent;

    let correct = 0;
    let wrong = 0;
    let attempted = 0;
    const total = currentQuiz.questions.length;

    currentQuiz.questions.forEach((q, i) => {
        const userAnsIndex = userAnswers[i];
        if (userAnsIndex !== undefined) {
            attempted++;
            if (userAnsIndex === q.ans) correct++;
            else wrong++;
        }
    });

    const unattempted = total - attempted;
    const scorePercent = Math.round((correct / total) * 100);
    const playerRankTitle = getRankTitle(correct, total); 
    
    // --- CRITICAL UPDATE: Use email as the key for BOTH Personal Results and Leaderboard ---
    const emailKey = encodeEmailToKey(currentUser.email);

    const resultData = {
        quizName: currentQuiz.title,
        userEmail: currentUser.email, // Store the readable email inside the result object
        stats: { attempted, correct, wrong, unattempted, total, scorePercent, rankTitle: playerRankTitle }, 
        timeTaken: timeDisplay,
        timestamp: Date.now()
    };

    const leaderboardEntry = {
        name: currentUser.displayName || 'Anonymous',
        // We rely on the emailKey for identification, but we store name/score/time
        score: correct, 
        totalQuestions: total,     
        timeSeconds: timeTakenSec,
        timeString: timeDisplay,   
        rankTitle: playerRankTitle, 
        timestamp: Date.now()
    };

    try {
        const updates = {};
        // 1. Personal Results (Now keyed by SANITIZED Email)
        // Path: results/sanitized_email/quiz_id
        updates[`results/${emailKey}/${currentQuiz.id}`] = resultData;
        
        // 2. Public Leaderboard (Keyed by SANITIZED Email)
        // Path: leaderboardquiz/quiz_id/sanitized_email
        updates[`leaderboardquiz/${currentQuiz.id}/${emailKey}`] = leaderboardEntry; 

        await update(ref(db), updates);
        
        showToast("Quiz Submitted Successfully! Results updated.");
        loadDashboard(); 
        
        renderReportCard(resultData, currentQuiz.id); 

    } catch (error) {
        console.error("Submission Error:", error);
        showToast("Error submitting quiz");
    }
}

// --- REPORT CARD ---
async function fetchAndShowResult(quizId) {
    if (!currentUser || !currentUser.email) {
         showToast("Cannot fetch result. Login required.");
         return;
    }
    // Use the sanitized email key to fetch the user's specific result
    const personalKey = encodeEmailToKey(currentUser.email);

    try {
        const snapshot = await get(child(ref(db), `results/${personalKey}/${quizId}`));
        if (snapshot.exists()) {
            renderReportCard(snapshot.val(), quizId);
        } else {
            showToast("Result not found for this user/quiz.");
        }
    } catch (error) {
        console.error("Error fetching result:", error);
        showToast("Error retrieving your result.");
    }
}

function renderReportCard(data, quizId) { 
    const { attempted, correct, wrong, unattempted, total, scorePercent, rankTitle } = data.stats;
    els.scorePercent.textContent = `${scorePercent}%`;
    els.resRankTitle.textContent = rankTitle || 'N/A';
    els.resCorrect.textContent = correct;
    els.resWrong.textContent = wrong;
    els.resAttempted.textContent = attempted;
    els.resUnattempted.textContent = unattempted;
    els.resTime.textContent = data.timeTaken;
    
    switchView('result');

    const lbBtn = document.getElementById('view-lb-from-res');
    // Clone and replace to prevent multiple event listeners on the same button instance
    const newBtn = lbBtn.cloneNode(true);
    lbBtn.parentNode.replaceChild(newBtn, lbBtn);
    
    newBtn.addEventListener('click', () => {
        loadLeaderboard(quizId || currentQuiz.id);
    });
}

els.backHomeBtn.addEventListener('click', () => {
    loadDashboard();
    switchView('dashboard');
});
// --- AUTO-SUBMIT ON TAB CLOSE ---
window.addEventListener('beforeunload', (e) => {
    if (currentQuiz) {
        // Submit only if a quiz is in progress
        submitQuiz();
        // Optionally, prevent default popup if you want confirmation:
        // e.preventDefault();
        // e.returnValue = '';
    }
});
// Warn user before closing/reloading tab during an ongoing quiz
window.addEventListener('beforeunload', (e) => {
    if (currentQuiz) { // Only trigger if a quiz is active
        e.preventDefault();
        e.returnValue = "You are leaving the quiz. Your answers so far will be saved automatically.";
        // The message may not show in all browsers, but the alert will trigger
    }
});

</script>
</body>
</html>