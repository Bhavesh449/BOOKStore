<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>BOOKStore Premium Player</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
    /* =========================================
       1. VARIABLES & RESET
       ========================================= */
    :root {
        --accent: #379dfd;
        --accent-glow: rgba(55, 157, 253, 0.6);
        --bg-dark: #0b1220;
        --glass-bg: rgba(15, 23, 42, 0.85);
        --glass-border: rgba(255, 255, 255, 0.08);
        --text-primary: #ffffff;
        --text-secondary: #cbd5e1;
        --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
        background: #000;
        margin: 0;
        padding: 0;
        color: var(--text-primary);
        font-family: 'Inter', sans-serif;
        overflow: hidden;
    }

    /* =========================================
       2. PLAYER CONTAINER
       ========================================= */
    .player-container {
        position: relative;
        width: 100vw;
        height: 100vh;
        background: #000;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
    }

    video {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }

    /* Book Logo - Watermark style */
    .book-logo {
        position: absolute;
        top: 25px;
        right: 30px;
        width: 50px;
        height: auto;
        opacity: 0.6;
        z-index: 50;
        pointer-events: none;
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
    }

    /* =========================================
       3. FLOATING CONTROLS
       ========================================= */
    .controls-and-seek-container {
        position: absolute;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%) translateY(0);
        width: 90%;
        max-width: 1000px;
        display: flex;
        flex-direction: column;
        gap: 15px;
        z-index: 100;
        transition: opacity 0.4s ease, transform 0.4s ease;
        opacity: 1;
        padding-bottom: 10px; /* Safe area */
    }

    /* Auto-hide State */
    .controls-and-seek-container.hidden {
        opacity: 0;
        transform: translateX(-50%) translateY(20px);
        pointer-events: none;
    }

    /* Glass Control Bar */
    .controls {
        width: 100%;
        background: var(--glass-bg);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid var(--glass-border);
        padding: 12px 24px;
        border-radius: 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }

    .controls-left, .controls-right {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    /* =========================================
       4. ICONS & BUTTONS
       ========================================= */
    .ctrl-icon {
        width: 24px;
        height: 24px;
        cursor: pointer;
        opacity: 0.85;
        transition: var(--transition);
        filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3));
    }

    .ctrl-icon:hover {
        opacity: 1;
        transform: scale(1.15);
        filter: drop-shadow(0 0 8px var(--accent-glow));
    }

    .ctrl-icon:active {
        transform: scale(0.95);
    }

    /* Play/Pause Button Specifics */
    #playPauseBtn {
        width: 28px;
        height: 28px;
    }

    /* Time Display */
    #timeDisplay {
        font-family: 'Inter', monospace;
        font-size: 13px;
        font-weight: 500;
        color: var(--text-secondary);
        min-width: 100px;
        text-align: center;
        cursor: pointer;
        transition: color 0.2s;
    }
    #timeDisplay:hover { color: #fff; }

    /* =========================================
       5. SEEK BAR (YouTube Style)
       ========================================= */
    .seek-wrapper {
        width: 100%;
        height: 8px; /* Hit area */
        display: flex;
        align-items: center;
        cursor: pointer;
        position: relative;
    }

    .seek-bar {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 4px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        outline: none;
        cursor: pointer;
        transition: height 0.1s ease;
        position: relative;
        z-index: 2;
    }

    .seek-wrapper:hover .seek-bar { height: 6px; }

    /* Progress Fill */
    .seek-bar::-webkit-slider-runnable-track {
        height: 100%;
        border-radius: 4px;
        background: linear-gradient(to right, var(--accent) var(--seek-pos, 0%), transparent var(--seek-pos, 0%));
    }

    /* Thumb (Hidden by default, shows on hover) */
    .seek-bar::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 14px;
        height: 14px;
        background: #fff;
        border-radius: 50%;
        transform: scale(0);
        transition: transform 0.1s;
        box-shadow: 0 0 10px rgba(0,0,0,0.5);
        margin-top: -4px; /* Center thumb vertically relative to track height change */
    }

    .seek-wrapper:hover .seek-bar::-webkit-slider-thumb {
        transform: scale(1);
    }

    /* Bottom Line Progress (Netflix Style) */
    .bottom-progress {
        position: absolute;
        bottom: 0;
        left: 0;
        height: 3px;
        background: var(--accent);
        width: 0%;
        z-index: 200;
        transition: width 0.1s linear;
        box-shadow: 0 -1px 10px var(--accent-glow);
    }

    /* =========================================
       6. VOLUME SLIDER
       ========================================= */
    .volume-box {
        display: flex;
        align-items: center;
        position: relative;
        height: 30px;
    }

    #volumeSlider {
        width: 0;
        height: 4px;
        -webkit-appearance: none;
        background: rgba(255,255,255,0.2);
        border-radius: 4px;
        margin-left: 0;
        opacity: 0;
        transition: var(--transition);
        overflow: hidden;
    }

    .volume-box:hover #volumeSlider {
        width: 70px;
        opacity: 1;
        margin-left: 10px;
    }

    #volumeSlider::-webkit-slider-thumb {
        -webkit-appearance: none;
        height: 12px;
        width: 12px;
        border-radius: 50%;
        background: #fff;
        box-shadow: 0 0 5px rgba(0,0,0,0.3);
        margin-top: -4px;
    }

    #volumeSlider::-webkit-slider-runnable-track {
        height: 4px;
        background: linear-gradient(to right, #fff var(--vol-pos, 100%), rgba(255,255,255,0.2) var(--vol-pos, 100%));
    }

    /* =========================================
       7. SETTINGS MENU
       ========================================= */
    .settings-menu {
        position: absolute;
        bottom: 70px; /* Above control bar */
        right: 0;
        width: 220px;
        background: rgba(18, 24, 38, 0.95);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: 12px;
        padding: 8px;
        display: none;
        flex-direction: column;
        gap: 4px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        animation: slideUp 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        z-index: 200;
    }

    @keyframes slideUp {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .main-setting-btn {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        color: var(--text-secondary);
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        border-radius: 8px;
        transition: background 0.2s;
    }

    .main-setting-btn:hover { background: rgba(255,255,255,0.08); color: #fff; }
    
    .main-setting-btn b { color: #fff; }
    .main-setting-btn::after {
        content: attr(data-current);
        font-size: 12px;
        color: var(--accent);
        font-weight: 600;
    }

    .drop-box {
        display: none;
        background: rgba(0,0,0,0.2);
        border-radius: 8px;
        margin-top: 4px;
    }

    .option {
        padding: 10px 16px;
        font-size: 13px;
        color: #ccc;
        cursor: pointer;
        display: flex;
        align-items: center;
    }
    .option:hover { background: rgba(255,255,255,0.05); color: #fff; }
    
    .option.active {
        color: var(--accent);
        font-weight: 600;
    }
    .option.active::before {
        content: '•';
        margin-right: 8px;
        font-size: 18px;
        line-height: 0;
    }

    .divider { height: 1px; background: rgba(255,255,255,0.1); margin: 4px 0; }

    /* =========================================
       8. POPUPS (Link & History)
       ========================================= */
    .glass-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(8px);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
    }
    
    .glass-overlay.show { opacity: 1; pointer-events: auto; }

    /* Right-side Slide-in for History */
    .glass-overlay.right { justify-content: flex-end; }
    .glass-overlay.right .glass-popup {
        height: 100vh;
        border-radius: 0;
        transform: translateX(100%);
        transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        width: 350px;
        max-width: 80vw;
        border-left: 1px solid var(--glass-border);
    }
    .glass-overlay.right.show .glass-popup { transform: translateX(0); }

    /* Standard Modal */
    .glass-popup {
        background: #111827;
        width: 400px;
        max-width: 90%;
        padding: 30px;
        border-radius: 20px;
        border: 1px solid var(--glass-border);
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
        transform: scale(0.95);
        transition: transform 0.3s ease;
    }
    .glass-overlay.show .glass-popup { transform: scale(1); }

    .glass-popup h2 {
        margin: 0 0 10px;
        font-size: 20px;
        font-weight: 600;
        color: #fff;
    }
    
    .glass-popup p {
        color: var(--text-secondary);
        font-size: 14px;
        margin-bottom: 20px;
    }

    /* Input Styling */
    .glass-popup input {
        width: 100%;
        background: rgba(255,255,255,0.05);
        border: 1px solid var(--glass-border);
        padding: 14px;
        border-radius: 12px;
        color: #fff;
        font-size: 14px;
        outline: none;
        transition: border 0.2s;
    }
    .glass-popup input:focus { border-color: var(--accent); }

    /* Button Styling */
    .glass-popup button {
        width: 100%;
        margin-top: 15px;
        padding: 14px;
        background: var(--accent);
        color: #fff;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: var(--transition);
        box-shadow: 0 4px 15px rgba(55, 157, 253, 0.3);
    }
    .glass-popup button:hover {
        background: #278ceb;
        transform: translateY(-2px);
    }

    .error-text { color: #ff4d4d; font-size: 12px; margin-top: 5px; min-height: 18px; }

    /* History List Items */
    #historyList {
        margin-top: 20px;
        height: calc(100% - 60px);
        overflow-y: auto;
        padding-right: 5px;
    }
    
    /* Scrollbar */
    #historyList::-webkit-scrollbar { width: 6px; }
    #historyList::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

    .history-item {
        background: rgba(255,255,255,0.03);
        border: 1px solid transparent;
        border-radius: 12px;
        padding: 12px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: var(--transition);
    }
    
    .history-item:hover {
        background: rgba(255,255,255,0.08);
        border-color: rgba(255,255,255,0.1);
        transform: translateX(4px);
    }

    .history-top { display: flex; justify-content: space-between; margin-bottom: 4px; }
    .history-title { font-weight: 500; font-size: 14px; color: #fff; outline: none; }
    .history-title:focus { border-bottom: 1px solid var(--accent); }
    .history-item small { color: #888; font-size: 11px; }

    /* Mobile Tweaks */
    @media (max-width: 600px) {
        .controls { padding: 10px 15px; }
        .controls-and-seek-container { width: 95%; bottom: 15px; }
        #volumeBox { display: none; } /* Hide volume on mobile to save space */
        .settings-menu { bottom: 60px; }
    }

</style>
</head>
<body>

<div class="player-container" id="playerContainer">
    <!-- Brand Logo -->
    <img src="book.png" alt="BOOKStore" class="book-logo">

    <!-- Video Element -->
    <video id="video" playsinline></video>
    
    <!-- Bottom Line Progress (Netflix Style) -->
    <div class="bottom-progress" id="bottomProgress"></div>

    <!-- Controls Container -->
    <div class="controls-and-seek-container" id="controlsContainer">
        
        <!-- Seek Bar -->
        <div class="seek-wrapper">
            <input type="range" id="seekBar" value="0" min="0" max="100" step="0.1" class="seek-bar">
        </div>

        <!-- Glass Control Bar -->
        <div class="controls" id="controls">
            
            <!-- Left Controls -->
            <div class="controls-left">
                <img src="backward.svg" id="back5" class="ctrl-icon" title="-5s">
                <img src="play.svg" id="playPauseBtn" class="ctrl-icon" title="Play/Pause">
                <img src="forward.svg" id="forward5" class="ctrl-icon" title="+5s">

                <div class="volume-box" id="volumeBox">
                    <img src="volume.svg" id="volumeBtn" class="ctrl-icon" title="Mute">
                    <input type="range" id="volumeSlider" min="0" max="1" step="0.05" value="1">
                </div>
                
                <span id="timeDisplay">00:00 / 00:00</span>
            </div>

            <!-- Right Controls -->
            <div class="controls-right">
                <img src="history.svg" id="historyBtn" class="ctrl-icon" title="History">
                <img src="settings.svg" id="settingsBtn" class="ctrl-icon" title="Settings">
                <img src="fullscreen.svg" id="fullscreenBtn" class="ctrl-icon" title="Fullscreen">
                
                <!-- Settings Dropdown -->
                <div class="settings-menu" id="settingsMenu">
                    <div class="main-setting-btn" data-open="speedBox" id="speedLabel" data-current="Normal">
                        <b>Speed</b>
                    </div>
                    <div class="setting-section drop-box" id="speedBox">
                        <div class="option" data-speed="0.25">0.25x</div>
                        <div class="option" data-speed="0.5">0.5x</div>
                        <div class="option active" data-speed="1">Normal</div>
                        <div class="option" data-speed="1.25">1.25x</div>
                        <div class="option" data-speed="1.5">1.5x</div>
                        <div class="option" data-speed="2">2x</div>
                    </div>

                    <div class="divider"></div>

                    <div class="main-setting-btn" data-open="qualityBox" id="qualityLabel" data-current="Auto">
                        <b>Quality</b>
                    </div>
                    <div class="setting-section drop-box" id="qualityBox">
                        <div class="option active" data-quality="auto">Auto</div>
                        <div class="option" data-quality="720">720p</div>
                        <div class="option" data-quality="480">480p</div>
                        <div class="option" data-quality="360">360p</div>
                        <div class="option" data-quality="240">240p</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Watch By Link Popup -->
<div class="glass-overlay" id="linkOverlay">
  <div class="glass-popup">
    <h2>Watch by Link</h2>
    <p>Enter a direct video URL (.mp4 or .m3u8)</p>
    <input type="text" id="videoLinkInput" placeholder="https://example.com/video.m3u8">
    <div class="error-text" id="linkError"></div>
    <button id="playLinkBtn">Start Watching</button>
  </div>
</div>

<!-- History Side Panel -->
<div class="glass-overlay right" id="historyOverlay">
  <div class="glass-popup history-panel">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h2>History</h2>
        <span style="cursor:pointer; font-size:20px;" onclick="closePopup(historyOverlay)">×</span>
    </div>
    <div id="historyList"></div>
  </div>
</div>

<!-- JAVASCRIPT Logic (Unchanged) -->
<script>
function extractVideoFromURL() {
    const path = decodeURIComponent(window.location.pathname);
    const search = window.location.search;

    const params = new URLSearchParams(search);
    const qVideo = params.get("video");
    if (qVideo) {
        const decoded = decodeURIComponent(qVideo);
        if (isValidVideo(decoded)) return decoded;
    }

    const marker = "/play.html/";
    if (path.includes(marker)) {
        let after = path.split(marker)[1];
        if (after.startsWith("https:/") && !after.startsWith("https://")) after = after.replace("https:/", "https://");
        if (after.startsWith("http:/") && !after.startsWith("http://")) after = after.replace("http:/", "http://");
        if (isValidVideo(after)) return after;
    }
    return null;
}

const params = new URLSearchParams(window.location.search);
const vid = params.get("video") || "0";
let showRemaining = false; 

const video = document.getElementById("video");
const seekBar = document.getElementById("seekBar");
const bottomProgress = document.getElementById("bottomProgress");
const playerContainer = document.getElementById("playerContainer");
const controlsContainer = document.getElementById("controlsContainer");
const timeDisplay = document.getElementById("timeDisplay");
const playBtn = document.getElementById("playPauseBtn");
const back5Btn = document.getElementById("back5");
const forward5Btn = document.getElementById("forward5");
const speedLabel = document.getElementById("speedLabel");
let isDragging = false;

function convertTimeToSeconds(t){
    const [m, s] = t.split(":").map(Number);
    return m * 60 + s;
}

timeDisplay.addEventListener("click", () => {
    showRemaining = !showRemaining;
    const dur = video.duration || 0;
    updateSeekVisuals(video.currentTime, dur);
});

function updateSeekVisuals(currentTime, duration) {
    if(!duration) return;
    const percent = (currentTime / duration) * 100;
    seekBar.style.setProperty("--seek-pos", percent + "%");
    bottomProgress.style.width = percent + "%";
    
    if (showRemaining) {
        const remaining = Math.max(0, duration - currentTime);
        timeDisplay.textContent = `-${formatTime(remaining)}`;
    } else {
        timeDisplay.textContent = `${formatTime(currentTime)} / ${formatTime(duration)}`;
    }
}

function loadVideo(videoURL) {
    if (Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(videoURL);
        hls.attachMedia(video);
        window.hls = hls;
        hls.on(Hls.Events.MANIFEST_PARSED, (event, data) => handleVideoType());
    } else {
        video.src = videoURL;
        video.onloadedmetadata = handleVideoType;
    }
}

// Fallback empty func if not defined in original context
function handleVideoType() {}

back5Btn.addEventListener("click", (e) => {
    e.stopPropagation();
    video.currentTime = Math.max(0, video.currentTime - 5);
    showControls();
});

forward5Btn.addEventListener("click", (e) => {
    e.stopPropagation();
    video.currentTime = Math.min(video.duration, video.currentTime + 5);
    showControls();
});

function formatTime(time) {
    time = Math.floor(time);
    let hours = Math.floor(time / 3600);
    let minutes = Math.floor((time % 3600) / 60);
    let seconds = time % 60;
    const hh = hours.toString().padStart(2, "0");
    const mm = minutes.toString().padStart(2, "0");
    const ss = seconds.toString().padStart(2, "0");
    if (hours === 0) return `${mm}:${ss}`;
    return `${hh}:${mm}:${ss}`;
}

video.addEventListener("timeupdate", () => {
    if (!isDragging) {
        const dur = video.duration || 1;
        updateSeekVisuals(video.currentTime, dur);
        seekBar.value = video.currentTime;
    }
});

function onSeekStart() { isDragging = true; }
function onSeekEnd() {
    if (isDragging) {
        video.currentTime = parseFloat(seekBar.value);
        isDragging = false;
    }
}
function onSeekInput() {
    if (!isDragging) return;
    const value = parseFloat(seekBar.value);
    const dur = video.duration || 1;
    updateSeekVisuals(value, dur);
}

seekBar.addEventListener("mousedown", onSeekStart);
seekBar.addEventListener("mouseup", onSeekEnd);
seekBar.addEventListener("mousemove", onSeekInput);
seekBar.addEventListener("touchstart", onSeekStart, { passive: true });
seekBar.addEventListener("touchend", onSeekEnd);
seekBar.addEventListener("touchmove", onSeekInput, { passive: true });

seekBar.addEventListener("keydown", (e) => {
    if (e.code === "ArrowLeft" || e.code === "ArrowRight") {
        onSeekStart();
        const step = video.duration * 0.01; 
        if (e.code === "ArrowLeft") seekBar.value = Math.max(0, seekBar.value - step);
        else seekBar.value = Math.min(video.duration, parseFloat(seekBar.value) + step);
        onSeekInput();
        onSeekEnd();
    }
});

video.addEventListener("loadedmetadata", () => {
    seekBar.max = video.duration;
    updateSeekVisuals(video.currentTime, video.duration);
});

// Drag fix
seekBar.isDragging = false; 
seekBar.addEventListener("mouseup", () => { 
    if (seekBar.isDragging) video.currentTime = Number(seekBar.value);
    seekBar.isDragging = false; 
});
seekBar.addEventListener("touchend", () => { 
    if (seekBar.isDragging) video.currentTime = Number(seekBar.value);
    seekBar.isDragging = false; 
});

// Volume Logic
let lastVolume = 1;
const volumeSlider = document.getElementById("volumeSlider");
const volumeBtn = document.getElementById("volumeBtn");

volumeSlider.addEventListener("input", (e) => {
    const val = parseFloat(e.target.value);
    video.volume = val;
    if(val === 0) {
        video.muted = true;
        volumeBtn.src = "mute.svg";
    } else {
        video.muted = false;
        volumeBtn.src = "volume.svg";
        lastVolume = val; 
    }
    const progress = (e.target.value * 100);
    volumeSlider.style.setProperty("--vol-pos", progress + "%");
});

volumeBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    if (video.muted || video.volume === 0) {
        video.muted = false;
        video.volume = lastVolume || 0.5;
        volumeSlider.value = video.volume;
        volumeBtn.src = "volume.svg";
    } else {
        lastVolume = video.volume;
        video.muted = true;
        video.volume = 0;
        volumeSlider.value = 0;
        volumeBtn.src = "mute.svg";
    }
    volumeSlider.dispatchEvent(new Event('input')); 
});

// Settings Logic
const settingsBtn = document.getElementById("settingsBtn");
const settingsMenu = document.getElementById("settingsMenu");

settingsMenu.addEventListener('click', e => e.stopPropagation());
settingsBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    settingsMenu.style.display = (settingsMenu.style.display === 'flex') ? 'none' : 'flex';
});

document.querySelectorAll(".main-setting-btn").forEach(btn => {
    btn.addEventListener("click", (e) => {
        e.stopPropagation();
        const id = btn.dataset.open;
        const box = document.getElementById(id);
        if (box.style.display === "block") {
            box.style.display = "none";
            return;
        }
        document.querySelectorAll(".drop-box").forEach(b => b.style.display = "none");
        box.style.display = "block";
    });
});

document.addEventListener('click', () => {
    settingsMenu.style.display = 'none';
});

settingsMenu.querySelectorAll("[data-speed]").forEach(item => {
    item.addEventListener("click", (e) => {
        e.stopPropagation();
        settingsMenu.querySelectorAll("[data-speed]").forEach(i => i.classList.remove("active"));
        item.classList.add("active");
        video.playbackRate = parseFloat(item.dataset.speed);
        speedLabel.dataset.current = item.innerText;
    });
});

const qualityLabel = document.getElementById("qualityLabel");
settingsMenu.querySelectorAll("[data-quality]").forEach(item => {
    item.addEventListener("click", () => {
        settingsMenu.querySelectorAll("[data-quality]").forEach(i => i.classList.remove("active"));
        item.classList.add("active");
        const q = item.dataset.quality;
        if (window.hls) {
            if (q === "auto") window.hls.currentLevel = -1;
            else {
                const levelIndex = window.hls.levels.findIndex(l => l.height == Number(q));
                if (levelIndex >= 0) window.hls.currentLevel = levelIndex;
            }
        }
        const displayText = q === "auto" ? "Auto" : item.innerText;
        qualityLabel.dataset.current = displayText;
    });
});

function togglePlayPause() {
    if (video.paused || video.ended) { 
        video.play(); 
        playBtn.src = "pause.svg"; 
    } else { 
        video.pause(); 
        playBtn.src = "play.svg"; 
    }
    showControls();
}

playBtn.onclick = (e) => { e.stopPropagation(); togglePlayPause(); };
video.onplay = () => { playBtn.src = "pause.svg"; showControls(); };
video.onpause = () => { playBtn.src = "play.svg"; showControls(); };
video.onclick = () => { togglePlayPause(); };

let inactivityTimer;
const INACTIVITY_MS = 3000;

function showControls() {
    controlsContainer.classList.remove("hidden");
    clearTimeout(inactivityTimer);
    document.body.style.cursor = 'default';
    if (!video.paused) {
        inactivityTimer = setTimeout(() => {
            controlsContainer.classList.add("hidden");
            document.body.style.cursor = 'none'; 
        }, INACTIVITY_MS);
    }
}

function attachActivityListeners(el) {
    ['mousemove','mousedown','touchstart','touchmove','keydown'].forEach(evt => {
        el.addEventListener(evt, showControls, { passive: true });
    });
}
attachActivityListeners(document);
attachActivityListeners(playerContainer);
showControls();

controlsContainer.addEventListener('mouseenter', () => {
    clearTimeout(inactivityTimer);
    controlsContainer.classList.remove('hidden');
});

controlsContainer.addEventListener('mouseleave', () => {
    if (!video.paused) {
        inactivityTimer = setTimeout(() => {
            controlsContainer.classList.add('hidden');
        }, INACTIVITY_MS);
    }
});

const fullscreenBtn = document.getElementById("fullscreenBtn");
function toggleFullscreen() {
    if (!document.fullscreenElement) {
        if (playerContainer.requestFullscreen) playerContainer.requestFullscreen();
        else if (playerContainer.webkitRequestFullscreen) playerContainer.webkitRequestFullscreen();
    } else {
        if (document.exitFullscreen) document.exitFullscreen();
    }
}
fullscreenBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleFullscreen(); });
document.addEventListener('fullscreenchange', () => {
    const fs = !!document.fullscreenElement;
    fullscreenBtn.src = fs ? "exit.svg" : "fullscreen.svg";
    showControls();
});
video.addEventListener('dblclick', () => toggleFullscreen());

document.addEventListener('keydown', (e) => {
    const tag = document.activeElement && document.activeElement.tagName;
    if (tag === 'INPUT' || tag === 'TEXTAREA') return;
    if (e.code === 'Space') { e.preventDefault(); togglePlayPause(); }
    else if (e.code === 'ArrowLeft') { e.preventDefault(); back5Btn.click(); showControls(); }
    else if (e.code === 'ArrowRight') { e.preventDefault(); forward5Btn.click(); showControls(); }
});

// Watch by Link & History Logic
const linkOverlay = document.getElementById("linkOverlay");
const historyOverlay = document.getElementById("historyOverlay");
const playLinkBtn = document.getElementById("playLinkBtn");
const videoLinkInput = document.getElementById("videoLinkInput");
const linkError = document.getElementById("linkError");
const historyBtn = document.getElementById("historyBtn");
const historyList = document.getElementById("historyList");
let currentVideoURL = "";

function isValidVideo(url) { return /\.(mp4|m3u8)(\?.*)?$/i.test(url); }
function getHistory() { return JSON.parse(localStorage.getItem("watchHistory") || "[]"); }
function saveHistory(data) { localStorage.setItem("watchHistory", JSON.stringify(data)); }
function openPopup(el) { el.classList.add("show"); }
function closePopup(el) { el.classList.remove("show"); }

window.addEventListener("load", () => {
    const videoFromURL = extractVideoFromURL();
    if (videoFromURL) {
        loadAndTrack(videoFromURL);
        closePopup(linkOverlay);
    } else {
        openPopup(linkOverlay);
        video.pause();
    }
});

playLinkBtn.onclick = () => {
    const url = videoLinkInput.value.trim();
    if (!isValidVideo(url)) {
        linkError.textContent = "Only .mp4 or .m3u8 links are supported";
        return;
    }
    linkError.textContent = "";
    loadAndTrack(url);
    closePopup(linkOverlay);
};

linkOverlay.addEventListener("click", e => { if (e.target === linkOverlay) closePopup(linkOverlay); });

function loadAndTrack(url) {
    if (currentVideoURL && currentVideoURL !== url) saveProgress(true);
    currentVideoURL = url;
    loadVideo(url);
    video.onloadedmetadata = () => {
        video.currentTime = 0;
        video.play();
    };
}

function saveProgress(force = false) {
    if (!currentVideoURL) return;
    if (!force && video.currentTime < 2) return;
    let history = getHistory();
    const existing = history.find(h => h.url === currentVideoURL);
    history = history.filter(h => h.url !== currentVideoURL);
    history.unshift({
        url: currentVideoURL,
        time: video.currentTime,
        date: new Date().toLocaleString(),
        title: existing?.title || currentVideoURL.split("/").pop()
    });
    saveHistory(history.slice(0, 50));
}

video.addEventListener("pause", () => saveProgress());
window.addEventListener("beforeunload", () => saveProgress());

historyBtn.onclick = () => {
    renderHistory();
    openPopup(historyOverlay);
};
historyOverlay.addEventListener("click", e => { if (e.target === historyOverlay) closePopup(historyOverlay); });

function renderHistory() {
    historyList.innerHTML = "";
    const history = getHistory();
    if (!history.length) {
        historyList.innerHTML = "<p style='opacity:.6; text-align:center'>No history yet</p>";
        return;
    }
    history.forEach((item, index) => {
        const div = document.createElement("div");
        div.className = "history-item";
        div.innerHTML = `
            <div class="history-top">
                <b contenteditable="false" class="history-title">${item.title}</b>
                <span class="rename-btn" style="opacity:0.6;font-size:12px">✎</span>
            </div>
            <small>Resume at ${formatTime(item.time)} • ${item.date}</small>
        `;
        div.onclick = (e) => {
            if (e.target.classList.contains("rename-btn") || e.target.classList.contains("history-title")) return;
            closePopup(historyOverlay);
            currentVideoURL = item.url;
            loadVideo(item.url);
            video.onloadedmetadata = () => {
                if (item.time > 5) video.currentTime = item.time;
                video.play();
            };
        };
        const titleEl = div.querySelector(".history-title");
        const renameBtn = div.querySelector(".rename-btn");
        renameBtn.onclick = (e) => {
            e.stopPropagation();
            titleEl.contentEditable = "true";
            titleEl.focus();
        };
        titleEl.onblur = () => {
            titleEl.contentEditable = "false";
            const newTitle = titleEl.innerText.trim();
            if (!newTitle) return;
            const all = getHistory();
            all[index].title = newTitle;
            saveHistory(all);
        };
        historyList.appendChild(div);
    });
}
</script>
</body>
</html>
